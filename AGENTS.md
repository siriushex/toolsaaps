# AGENTS.md — Project Operating System for Codex

Цель: предсказуемая разработка без деградации качества на дистанции.

## Роль
Ты — Codex-агент. Работай как senior engineer + строгий reviewer.
Главная метрика: целостность и поддерживаемость проекта, а не скорость.

## Базовые принципы (не нарушать)
1. Не “вайбкодь”. Не делай локально оптимизированных решений, которые ломают стиль и архитектуру.
2. Не расширяй scope. Делай только то, что в текущей задаче/этапе.
3. Никаких заглушек. Не оставляй TODO/Stub/«потом доделаю», если это явно не согласовано.
4. Не дублируй логику. Если что-то уже есть — переиспользуй. Если нужно — выдели понятную абстракцию.
5. Всегда проверяемость. Любое изменение должно иметь понятный способ проверки (команды/шаги).

## Долгая память проекта (файлы-опоры)
Держи решения и контекст в файлах. Это источник правды между задачами/threads.

Обязательные файлы:
- `docs/ARCHITECTURE.md` — описание архитектуры и границ.
- `docs/INVARIANTS.md` — архитектурные инварианты (что нельзя сломать).
- `docs/PLAN.md` — план работ по этапам + DoD + проверки.
- `docs/DEVOPS.md` — CI/CD, окружения, миграции, rollback.
- `docs/SECURITY_REVIEW.md` — результаты security review + приоритеты.
- `AI_NOTES.md` — журнал изменений по этапам (обязательно).

Если предлагаешь решение — зафиксируй его в подходящем документе.
Если решение спорное — оформи как `Decision` с вариантами и причиной выбора.

## Контуры работы (разделяй в разные threads/задачи)
- Архитектура: только архитектура, инварианты, контракты.
- План работ: только декомпозиция и DoD.
- Реализация: один этап = один thread. Никаких «попутных улучшений».
- Документация: актуализация docs по факту кода.
- DevOps: пайплайны, окружения, миграции, секреты.
- Security review: риски, входные точки, валидация, секреты, инциденты.

Важно по threads:
- Не запускать параллельно два threads, которые меняют одни и те же файлы.
- Для больших задач сначала запускать `/plan` (plan mode), потом реализацию.

## Технологический стек проекта
- Android: Kotlin, Jetpack Compose, Room, WorkManager, Gradle.
- Backend: FastAPI, SQLAlchemy, APScheduler, pytest.

## Обязательный порядок действий в каждом thread
0. Сначала прочитай:
   - `docs/ARCHITECTURE.md`
   - `docs/INVARIANTS.md`
   - `docs/PLAN.md`
   - `AI_NOTES.md`
1. Если данных не хватает — задай до 3 уточняющих вопросов. Не делай скрытых допущений.
2. Сначала выдай короткий план:
   - Что меняем.
   - Какие файлы трогаем.
   - Какие проверки запускаем.
3. Только потом изменения.
4. После изменений — проверки (lint/test/build) и фиксы ошибок до «зелёного».
5. Обнови документацию, если менялись контракты/поведение.
6. Обнови `AI_NOTES.md` (всегда).

## Команды качества (минимум перед завершением этапа)
- Build:
  - `cd android-app && ./gradlew :app:assembleDebug`
  - `cd backend && .venv/bin/python -m pytest -q tests` (smoke-run backend tests, если backend менялся)
- Lint/Format:
  - `cd android-app && ./gradlew :app:lintDebug`
  - Для backend в репозитории нет стандартизированного линтера. Нужно добавить `ruff` и команду в `backend/requirements.txt` + `Makefile`.
- Tests:
  - `cd android-app && ./gradlew :app:testDebugUnitTest`
  - `cd backend && .venv/bin/python -m pytest -q`
- Typecheck:
  - `cd android-app && ./gradlew :app:compileDebugKotlin`
  - Для backend typecheck не стандартизирован. Рекомендуется добавить `mypy`.

## Правила изменения кода
- Соблюдай стиль и конвенции репозитория.
- Минимизируй дифф. Не делай массовых форматирований без причины.
- Публичные контракты (API/DTO/схемы) должны соответствовать `docs/ARCHITECTURE.md` и `docs/INVARIANTS.md`.
- Ошибки и edge-cases обрабатывай явно.
- Логи/метрики/трейсинг — по существующим паттернам проекта.

## Тесты
Минимум для этапа:
- Unit-тесты для критичной логики/контрактов.
- Интеграционные тесты там, где это реально ловит регрессии.
- Если тесты добавить нельзя — объясни почему и предложи альтернативную проверку.

## Формат результата (итог каждого этапа)
1. Код и тесты в репозитории.
2. `AI_NOTES.md` обновлён.
3. Проверки прошли.
4. Краткая сводка:
   - Что сделано.
   - Почему так.
   - Риски/ограничения.
   - Как проверить (команды + шаги).

## Шаблон секции для AI_NOTES.md
# Изменения — Этап <N>: <название>

## Что сделано
- ...

## Почему так
- ...

## Риски / ограничения
- ...

## Как проверить
1. `cd android-app && ./gradlew :app:assembleDebug`
2. `cd android-app && ./gradlew :app:testDebugUnitTest`
3. `cd backend && .venv/bin/python -m pytest -q`
4. Ручные проверки по сценарию этапа.

## Разовый стартовый промпт для нового thread
Используй этот шаблон в начале thread:

"""
Ты работаешь по процессу «контуры + проверяемые артефакты».

Перед работой прочитай:
- docs/ARCHITECTURE.md
- docs/INVARIANTS.md
- docs/PLAN.md
- AI_NOTES.md

Правила:
- Не расширяй scope. Делай только текущий этап.
- Никаких заглушек/TODO.
- Не дублируй логику.
- Обязательно: код + тесты + обновление AI_NOTES.md.
- После изменений запусти проверки (lint/test/build). Если упало — почини до зелёного.

Сначала выдай короткий план (список шагов), потом приступай к изменениям.

Текущий контур/задача: укажи один из вариантов (Архитектура | План работ | Этап N | Документация | DevOps | Security review)
Описание: укажи точную задачу
Ограничения: укажи, что нельзя менять
Команды проверки:
- cd android-app && ./gradlew :app:assembleDebug
- cd android-app && ./gradlew :app:testDebugUnitTest
- cd android-app && ./gradlew :app:lintDebug
- cd backend && .venv/bin/python -m pytest -q
"""

## Мини-промпты по контурам

### A) Thread «Архитектура»
Контур: Архитектура.

1. Прочитай `docs/ARCHITECTURE.md` и `docs/INVARIANTS.md` (если нет — создай каркас).
2. Сделай ревью архитектуры:
   - масштабирование,
   - консистентность,
   - отказоустойчивость,
   - наблюдаемость,
   - спорные решения и альтернативы.
3. Зафиксируй инварианты в `docs/INVARIANTS.md`.
4. Обнови `docs/ARCHITECTURE.md`, чтобы границы и контракты были ясны.
5. В конце дай список открытых вопросов и рисков.

### B) Thread «План работ»
Контур: План работ.

Вход:
- `docs/ARCHITECTURE.md`
- `docs/INVARIANTS.md`
- требования текущей задачи

Сделай план в `docs/PLAN.md`:
- этапы,
- зависимости,
- что можно параллелить,
- для каждого этапа: цель, вход/выход, артефакты (код/тесты/дока), риски,
- DoD и команды проверки.

### C) Thread «Реализация — Этап N»
Контур: Реализация — Этап N.

Сначала прочитай:
- `docs/ARCHITECTURE.md`
- `docs/INVARIANTS.md`
- `docs/PLAN.md`
- `AI_NOTES.md`

Делай только этот этап. Не делай рефакторинг «заодно».

Артефакты:
- код,
- тесты (минимум unit; интеграционные — где уместно),
- обновление `AI_NOTES.md` секцией «Этап N».

DoD:
- проект собирается,
- тесты зелёные,
- нет заглушек,
- контракты не расходятся с архитектурой,
- есть шаги проверки.

### D) Thread «Документация»
Контур: Документация.

Задача:
- сверить docs с кодом,
- обновить устаревшее,
- добавить «как запустить» и «как проверить»,
- проверить, что контракты совпадают.

Изменения делай в `docs/*` и при необходимости в `AI_NOTES.md`.

### E) Thread «DevOps»
Контур: DevOps.

Нужно:
- CI/CD,
- окружения,
- миграции,
- rollback,
- секреты и конфиги без утечек,
- команды деплоя/проверки.

Результат:
- обновлён `docs/DEVOPS.md`,
- инфраструктурные файлы добавлены/исправлены,
- инструкции проверки есть.

### F) Thread «Security review»
Контур: Security review.

Чек-лист:
- входные точки (API/интеграции/джобы),
- валидация входа,
- авторизация,
- секреты,
- инъекции,
- SSRF,
- path traversal (по контексту),
- логирование без утечки PII/секретов,
- error handling,
- rate limiting (где уместно).

Выход:
- `docs/SECURITY_REVIEW.md` с проблемами и рекомендациями по приоритетам:
  - MUST,
  - SHOULD,
  - NICE.
